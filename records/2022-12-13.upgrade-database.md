# TITLE

Date: 2022-12-13

## Status

**DRAFT**.

## Context

[Staging](https://ca-central-1.console.aws.amazon.com/rds/home?region=ca-central-1#database:id=notification-canada-ca-staging-cluster;is-cluster=true;tab=configuration) and 
[production](https://ca-central-1.console.aws.amazon.com/rds/home?region=ca-central-1#database:id=notification-canada-ca-production-cluster;is-cluster=true;tab=configuration) are both running aurora-postgresql 11.13 (from 2021-08-12). The latest version of PostgeSQL available on AWS is 14.5. The latest version of PostgeSQL is 15.1.

AWS recommended that we upgrade to at least 11.16 by July 23, 2022.

## Options

According to [Upgrading the PostgreSQL DB engine for Amazon RDS](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_UpgradeDBInstance.PostgreSQL.html) we cannot go straight to 14.5. Our options are:
- 11.17
- 12, ie 12.8, 12.9, 12.10, 12.11, or 12.12
- 13.14 (AWS maximum recommended upgrade)

According to [AWS](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_UpgradeDBInstance.PostgreSQL.html):

**Major version upgrades**

Major version upgrades can contain database changes that are not backward-compatible with existing applications. As a result, you must manually perform major version upgrades of your DB instances. You can initiate a major version upgrade by modifying your DB instance. However, before you perform a major version upgrade, we recommend that you follow the steps described in [Choosing a major version upgrade for PostgreSQL](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_UpgradeDBInstance.PostgreSQL.html#USER_UpgradeDBInstance.PostgreSQL.MajorVersion). During a major version upgrade, Amazon RDS also upgrades all of your in-Region read replicas along with the primary DB instance.

**Minor version upgrades**

In contrast, minor version upgrades include only changes that are backward-compatible with existing applications. You can initiate a minor version upgrade manually by modifying your DB instance. Or you can enable the Auto minor version upgrade option when creating or modifying a DB instance. Doing so means that your DB instance is automatically upgraded after Amazon RDS tests and approves the new version. If your PostgreSQL DB instance is using read replicas, you must first upgrade all of the read replicas before upgrading the primary instance. If your DB instance is in a Multi-AZ deployment, then the writer and any standby replicas are upgraded simultaneously. Therefore, your DB instance might not be available until the upgrade is complete. For more details, see [Automatic minor version upgrades for PostgreSQL](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_UpgradeDBInstance.PostgreSQL.html#USER_UpgradeDBInstance.PostgreSQL.Minor). For information about manually performing a minor version upgrade, see [Manually upgrading the engine version](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_UpgradeDBInstance.Upgrading.html#USER_UpgradeDBInstance.Upgrading.Manual).

### 11.17

Likely not risky.

### 12

There are [breaking changes](https://www.postgresql.org/docs/12/release-12.html#id-1.11.6.18.4) from 11 to 12. Unknown if any affect us.

### 13.14

There are also [breaking changes](https://www.postgresql.org/docs/13/release-13.html#id-1.11.6.14.4) from 12 to 13. Unknown if any affect us.

## Upgrade approaches

From [Upgrade your Amazon RDS for PostgreSQL or Amazon Aurora PostgreSQL database, Part 1: Comparing upgrade approaches](https://aws.amazon.com/blogs/database/part-1-upgrade-your-amazon-rds-for-postgresql-database-comparing-upgrade-approaches/) there are a few approaches we can use.

### Option A: In-place upgrade
This is in some ways the easiest, in that we essentially tell AWS to upgrade the database and it does it. The downside is that the database will be unavailable for most of the upgrade time, and hence Notify will be down. Also, if something goes wrong we would have to restore the database from a backup (and hope that works).

### Option B: Snapshot approach
In this approach we would make a copy of the database and upgrade that copy, then switch the app to use the new database. The benefit is that if something doesn't work we can quickly switch back to the old database. This approach still requires downtime during the process though, since data added to the old database would not be in the new database.

### Option C: AWS DMS approach
We can use the AWS Database Migration Service. Here we create a new database with the new version, then turn on DMS. The old data will be copied into the new database. Also, any data added during this time will also be copied over. We then stop Notify, let any remaining data go to the new database, point Notify at the new database, and restart.
This is a fairly straightforward approach (as these things go) and will have less downtime than other methods. Note that DMS does not work with all data types or database configurations, so it might not be an option.

### Option D: Replication-based approach using pglogical
This approach use the `pglogical` database extension along with database replication sets (A replication set is way to mark a collection of tables to be replicated.). In many ways this is very similar to Option C, however in this case once the new database is populated it stays up to date faster, and there is no "wait for last entries to transfer" downtime. Rather we just have to turn off Notify, switch to the new database, and turn Notify back on (and then turn off the extension). There are restriction on what database configurations are acceptible, however, and this is a more manual process than using DMS.

### Discussion

We want to minimize downtime and maximize probability of success. 
- There probably isn't too much to be gained performance-wise by just moving to 11.16, so we should move to 12.12 or 13.14. Just moving to 12.12 will increase the probability of success, at the expense of having to do anothe migration at a future point.
- Note that one benefit to just a minor upgrade would be that we could be confident that any issues that arise are due to our migration and not to the version change. So we could use a 11.16 upgrade as an opportunity to gain familiarityt with the migration process.
- Option A is probably the worst on both scores. 
- Option B give us the ability to quickly switch to the old database if things go wrong, but the downtime will be the same (likely a bit longer because we need to also take the snapshot). 
- Options C and D probably have the same downtime for us (if we do this on a Saturday evening, for example, there will not be may notifications sent during Option C's "wait for last entries to transfer" window)
- Option C may be less manual and more documented / supported. Both approaches require multiple manual steps however.

## Additional considerations

Aurora Serverless v2 might be an appropriate fit for Notify. In particular it allows better up and down compute scaling for bursty usage, which is Notify's pattern. However Serverless v2 only supports PostgreSQL 13.6 and above, so we would have to migrate up from our current 11.13 before moving to Serverless.

### Extensions

From `SELECT * FROM pg_extension;` we see that we are using extensions `plpgsql` and `pgcrypto` on staging and `plpgsql`, `pgcrypto` and `tablefunc` on production.

From [Extension versions for Amazon RDS for PostgreSQL](https://docs.aws.amazon.com/AmazonRDS/latest/PostgreSQLReleaseNotes/postgresql-extensions.html)
- plpgsql: same version (1.0) for all engine versions. No upgrade required.
- pgcrypto: same version (1.3) for all engine versions. No upgrade required.
- tablefunc: same version (1.0) for all engine versions. No upgrade required.

### Downtime

Depending on our approach this may require database downtime. If so we should have a proper maintenance window where Notify admin displays a "Notify is unavailable" page and the api returns a "Notify is unavailable" error message.

### Terraform

Note that our [terraform](https://github.com/cds-snc/notification-terraform/blob/main/aws/rds/rds.tf#L72) sets the engine version to 11.9, but adds the engine version to the `ignore_changes` section. So we do not have to change our terraform to change the engine version.

However we have a custom [RDS cluster parameter group](https://github.com/cds-snc/notification-terraform/blob/main/aws/rds/rds.tf#L41) that is using `aurora-postgresql11` for the `family`. If we move to 12 or 13 we probably have to change the family here.

## Decision

_TODO: Describe the way forward._

## Process


Since this is not a simple terraform tweak we should document the precise process we follow.

## Consequences

_TODO: Describe foreseen and felt consequences of the decision (possible after 1-3 months)._
