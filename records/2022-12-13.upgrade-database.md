# TITLE

Date: 2022-12-13

## Status

**DRAFT**.

## Context

[Staging](https://ca-central-1.console.aws.amazon.com/rds/home?region=ca-central-1#database:id=notification-canada-ca-staging-cluster;is-cluster=true;tab=configuration) and 
[production](https://ca-central-1.console.aws.amazon.com/rds/home?region=ca-central-1#database:id=notification-canada-ca-production-cluster;is-cluster=true;tab=configuration) are both running aurora-postgresql 11.13 (from 2021-08-12). The latest version of PostgeSQL available on AWS is 14.5. The latest version of PostgeSQL is 15.1.

AWS recommended that we upgrade to at least 11.17 by July 23, 2022.

## Options

According to [Upgrading the PostgreSQL DB engine for Amazon RDS](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_UpgradeDBInstance.PostgreSQL.html) we cannot go straight to 14.5. Our options are:
- go to 11.17
- go to 12, ie 12.8, 12.9, 12.10, 12.11, or 12.12
- go to 13.14 (AWS maximum recommended upgrade)

According to [AWS](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_UpgradeDBInstance.PostgreSQL.html):

**Major version upgrades**

Major version upgrades can contain database changes that are not backward-compatible with existing applications. As a result, you must manually perform major version upgrades of your DB instances. You can initiate a major version upgrade by modifying your DB instance. However, before you perform a major version upgrade, we recommend that you follow the steps described in [Choosing a major version upgrade for PostgreSQL](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_UpgradeDBInstance.PostgreSQL.html#USER_UpgradeDBInstance.PostgreSQL.MajorVersion). During a major version upgrade, Amazon RDS also upgrades all of your in-Region read replicas along with the primary DB instance.

**Minor version upgrades**

In contrast, minor version upgrades include only changes that are backward-compatible with existing applications. You can initiate a minor version upgrade manually by modifying your DB instance. Or you can enable the Auto minor version upgrade option when creating or modifying a DB instance. Doing so means that your DB instance is automatically upgraded after Amazon RDS tests and approves the new version. If your PostgreSQL DB instance is using read replicas, you must first upgrade all of the read replicas before upgrading the primary instance. If your DB instance is in a Multi-AZ deployment, then the writer and any standby replicas are upgraded simultaneously. Therefore, your DB instance might not be available until the upgrade is complete. For more details, see [Automatic minor version upgrades for PostgreSQL](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_UpgradeDBInstance.PostgreSQL.html#USER_UpgradeDBInstance.PostgreSQL.Minor). For information about manually performing a minor version upgrade, see [Manually upgrading the engine version](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_UpgradeDBInstance.Upgrading.html#USER_UpgradeDBInstance.Upgrading.Manual).

### 11.17

Likely not risky.

### 12

There are [breaking changes](https://www.postgresql.org/docs/12/release-12.html#id-1.11.6.18.4) from 11 to 12. Unknown if any affect us.

### 13.14

There are also [breaking changes](https://www.postgresql.org/docs/13/release-13.html#id-1.11.6.14.4) from 12 to 13. Unknown if any affect us.


## Additional considerations

It appears that even a minor upgrade requires database downtime. We should have a proper maintenance window where Notify admin displays a "Notify is unavailable" page and the api returns a "Notify is unavailable" error message. 

Note that our [terraform](https://github.com/cds-snc/notification-terraform/blob/main/aws/rds/rds.tf#L72) sets the engine version to 11.9, but adds the engine version to the `ignore_changes` section. So we do not have to change our terraform to change the engine version.

However we have a custom [RDS cluster parameter group](https://github.com/cds-snc/notification-terraform/blob/main/aws/rds/rds.tf#L41) that is using `aurora-postgresql11` for the `family`. If we move to 12 or 13 we probably have to change the family here.

## Decision

_TODO: Describe the way forward._

## Consequences

_TODO: Describe foreseen and felt consequences of the decision (possible after 1-3 months)._
