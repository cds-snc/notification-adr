# Enforcing priority lanes

Date: 2022-03-08

## Status

**DRAFT.**

## Context

Listing contextual elements to consider prior to offer suggestions and deepen our understanding of current limitations.

### Redis inboxes

We currently have 2 inboxes for batch saving via Redis (email and sms). Batches of notifications are taken out in the order they were POSTed. This means high priority notifications might have to wait behind a large number of bulk notifications.

## Current Implementation

![Current Batch Saving](https://user-images.githubusercontent.com/8869623/160944266-48cf19fb-ad07-411b-8f73-88616697f9a8.jpeg)

We store all notifications that come throught the API into a Redis List (Inbox). A process takes the notifications from Inbox and makes lists of a certain chunk size. Each list get processed as a single unit and gets saved to the Database. Instead of saving a single notification at a time, we are now saving a list of notifications (batch) in a single transacation.

### The database-tasks SQS queue

Database operations are all sent through the database-tasks queue/worker. This has a benefit of lining up and tracking a batch of operations to reduce the load. A major downside is that this is a bottleneck for high priority database operations such as saving a notification that needs to be sent in the next seconds. There are use cases when GCNotify is constantly hit and the database-tasks queue grows bigger. There are no FIFO strategy set on this queue as we are targeting high volume processing. This means though that no priority distinction is possible for operations going through it.

## Priority Queues
Here is an aggregate for the amount of notifications sent using a priority template:

| Date    | Count |
| :---        | :----   |
| 2022-03-14   | 3976     |
| 2022-03-15   | 4694      |
| 2022-03-16   | 4539     |
| 2022-03-17  | 4418     |
| 2022-03-18   | 4302     |
| 2022-03-19  | 3314     |
| 2022-03-20  | 3271     |
| 2022-03-21  | 3762     |

The above data was taken into consideration while designing a system that will work for Prioirty Batch notifications.

## Requirements

1. We need to process to Priority Notifications at a faster pace than Normal / Bulk notifications
2. We should be able to use the Batch Saving [workflow](https://github.com/cds-snc/notification-adr/blob/main/records/2021-09-27.batch-celery-save.md).

## Options

Listed in this section are different options available to us to improve our priority lanes.

1. ### Improving Redis inboxes
   We would add two new inboxes: Priority Email and Priority SMS. By setting up different inboxes we can easily batch those notifications faster than the rest.

2. ### Specific Beat Functions
   The current beat functions have a cadence of 10 seconds. We would have beat workers work at a faster cadence.

3. ### Improve Queuing
   We currently send all notifications to the Database Queue. We can split the Priority Notifications to be sent to a Priority Queue.

![Batch Saving with Priority Lanes](https://user-images.githubusercontent.com/8869623/160944323-93665287-3733-4ab0-b6fb-218aa0b196c2.jpeg)

## Things to Consider

We will be setting up the exact same pipeline that we currently have for notifications, just with a higher Cadence for delivery.

Due to the low number of priority notifications sent through out the day, we should use the Standard SQS queue instead of the First in First Out Queue. The likelihood of a need for a FIFO queue is low.

## Consequences & Results

_To be completed_.
