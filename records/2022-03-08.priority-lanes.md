# Enforcing priority lanes

Date: 2022-03-08

## Status

**DRAFT.**

## Context

Listing contextual elements to consider prior to offer suggestions and deepen our understanding of current limitations.

### Redis inboxes

We currently have 2 inboxes for batch saving via Redis (email and sms). Batches of notifications are taken out in the order they were POSTed. This means high priority notifications might have to wait behind a large number of bulk notifications.

### Current Implementation

![Current Batch Saving](https://user-images.githubusercontent.com/8869623/158684220-ba11102a-64ba-418b-8dd7-74f49c5f0cfa.png)

We store all notifications that come throught the API into a Redis List (Inbox). A process takes the notifications from Inbox and makes lists of a certain chunk size. Each list get processed as a single unit and gets saved to the Database. Instead of saving a single notification at a time, we are now saving a list of notifications (batch) in a single transacation.

### The database-tasks SQS queue

Database operations are all sent through the database-tasks queue/worker. This has a benefit of lining up and tracking a batch of operations to reduce the load. A major downside is that this is a bottleneck for high priority database operations such as saving a notification that needs to be sent in the next seconds. There are use cases when GCNotify is constantly hit and the database-tasks queue grows bigger. There are no FIFO strategy set on this queue as we are targeting high volume processing. This means though that no priority distinction is possible for operations going through it.

## Priority Queues
Here is an aggregate for the amount of notifications sent using a priority template:

| Date    | Count |
| :---        | :----   |
| 2022-03-14   | 3976     |
| 2022-03-15   | 4694      |
| 2022-03-16   | 4539     |
| 2022-03-17  | 4418     |
| 2022-03-18   | 4302     |
| 2022-03-19  | 3314     |
| 2022-03-20  | 3271     |
| 2022-03-21  | 3762     |

The above data was taken into consideration while designing a system that will work for Prioirty Batch notifications.

## Options

Listed in this section are different options available to us to improve our priority lanes.

### Improving Redis inboxes

* We could have different inboxes for different priorities / notification types. We could then have the associated periodic function favour the high priority inbox, or (probably better) we could have a different periodic task for each priority.

This would mean

### Improving database-tasks SQS queue

* Making it faster
* Getting high priority database operations out of it; but these need to be low volume.

## Decision

_TODO_.

## Consequences & Results

_To be completed_.
