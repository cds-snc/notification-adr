# Bounce rate automated emergency brake
Date: 2023-01-26

## Status
**DRAFT**.
_VALUES: (DRAFT, IN REVIEW, APPROVED, REJECTED)_

## Context

### Why the bounce rate is important
A high bounce rate often indicates large amounts of unsolicited email are being sent and email providers take this into account when deciding whether to deliver email.  A high bounce rate can cause emails to be sent to users' spam folders and AWS could suspend our email sending capability if our bounce rate exceeds a certain threshold.

### What is the bounce rate
The bounce rate is a metric monitored by AWS for each user of their Simple Email Service (SES) platform. A bounce occurs when an email is rejected by a recipient's mail system and may not be delivered. 

### Hard and soft bounces
A hard bounce occurs when an email is sent but cannot be delivered due to a persistent issue such as an invalid email address. These emails will not be retried. 

A soft bounce occurs due to a temporary failure, such as a mailbox being full, a mailbox being temporarily unavailable or a mail server being overloaded. These bounces do not initially count towards the bounce rate.  SES will automatically retry for a period of time, after which the email will be marked as a hard bounce.

### Bounce rate calculation
AWS calculates the bounce rate as the number of hard bounces per the total number of sent emails, expressed as a percentage:
![bouncerateformula](./diagrams/2023-01-26.bounce-rate-automated-emergency-brake/bouncerate.png)

### AWS Thresholds
- A bounce rate is considered **Healthy** when it remains below 5%.
- A bounce rate is considered **Under review** when it is between 5% and 10% (>=5% and <10%).
- A bounce rate is considered **At risk** when it is greater than or equal to 10%.

### How GC Notify's bounce rate is measured by AWS
All services using the GC Notify platform are seen in aggregate by AWS. The GC Notify platform as a whole has a single bounce rate. Individual services contribute to the bounce rate, with higher-volume services having a larger impact than lower-volume services.

## Why this feature is needed
The purpose of this feature is to keep the bounce rate as low as possible which will mean a positive sending reputation for the GC Notify platform. This will ensure emails are consistently trusted and delivered by email providers.  This can be done by monitoring each service's bounce rate and automatically suspending their service when they reach a certain threshold.  It will also be necessary to provide users with guides to explain these concepts and help to them reduce their bounce rate.

## Proposed solution

### Calculate service bounce rates
Record the bounce status of every notification and calculate number of emails sent and the bounce rate for each service over the past [bounce-rate-window]

### Notify a service when its bounce rate is at [bounce-rate-warning-percentage]
When a service's bounce rate reaches [bounce-rate-warning-percentage], notify the service owner so they can take action to reduce their bounce rate.  The message should contain a link to the service's dashboard where they can see their bounce rate and take action to reduce it.

#### Minimum volume threshold for warning a service
Low-volume senders won't have a large impact on the bounce rate, and notifying them directly may lead to many support calls. In order to limit this, only notify services that are sending more than [bounce-rate-warning-notification-volume-minimum] emails in the [bounce-rate-window].  This minimum could either be a fixed number or a percentage of the total number of emails sent by all services.

### Suspend a service when it reaches the [bounce-rate-critical-percentage]
When a service's bounce rate reaches the [bounce-rate-critical-percentage], suspend their service to prevent them from sending any more emails. Notify the GC Notify admins as well as the service owner that their service has been suspended and provide them with a link to the service's dashboard where they can see their bounce rate and take action to reduce it.

#### Un-suspending a service
When a service is suspended, we will need a process to follow to get them operational again.  This could look like:
- communicating with users through support to tell them what the issue is and provide a fix on their end first
- looking at our AWS account bounce rate and determine if we are in a danger zone
- once users have fixed their distribution list, reviewing their fix and wait for Notify bounce rate to go down if in a dangerous zone to reactivate the service
- monitoring the service and their bounce rate in the following days to check that their fix was effective

### Add bounce rate information to the service dashboard
Add a service's bounce rate to the service dashboard so that service owners can see their bounce rate and proactively read the guidance on it so they can prevent their bounce rate from rising in the first place.  

#### Minimum volume threshold for bounce rate display
Bounce rates should only be displayed once a service sends a minimum number of emails in the [bounce-rate-window]. This will prevent us from displaying bounce rate warnings or errors when a service has only sent a few emails. 

### Provide bounce rate guidance
Provide guidance to service owners to explain bounce rate concepts and how they apply to their service.  Provide guidance on how services can keep their bounce rate low. 

### Bounce rate calculation for a service
The formula for calculating a service's bounce rate will be the total number of hard bounces the service received divided by the total number of emails the service sent during the [bounce-rate-window].  

## Staggered roll-out
To prevent suspending services that may not actually be causing issues with the overall bounce rate, it is suggested to roll out this feature in stages.  The first stage would include tracking bounces, calculating bounce rates, and displaying them on service dashboards. It would also include bounce rate guidance for services. Once we are sure our calculations work satisfactorily with live data, we would move to the second stage which will include notifying services when they are reach the [bounce-rate-warning-percentage] and suspending services when they reach the [bounce-rate-critical-percentage].

## Additional considerations

### How GC Notify handles bounce notifications from SES
GC Notify uses a lambda function named `ses-to-sqs-email-callbacks` to handle bounce notifications sent back from SES.  When a callback comes in, the lambda function parses the bounce notification and sends it a queue to be picked up and run by the celery task `process-ses-result`.  The `process-ses-result` task updates the status of the notification in the database including whether it was a hard or a soft bounce.



## Consequences

_TODO: Describe foreseen and felt consequences of the decision (possible after 1-3 months)._

## References
- _Bounce and complaint rates_: https://docs.aws.amazon.com/pinpoint/latest/userguide/channels-email-deliverability-dashboard-bounce-complaint.html
- _Email Definitions: Bounces_: https://aws.amazon.com/blogs/messaging-and-targeting/email-definitions-bounces/

