# Scalability: increasing send rates

Date: 2023-06-27

## Status

**DRAFT**.

## Context

As Notify usage grows (and in particular as we anticipate increasing usage by PTMs) we need to increase our email and SMS send rates.

## Initial Goals

We should be able to approach the rates that AWS sets.

### Email

Currently in staging and production our email limit with SES is [100 emails / second or 200K / day](https://ca-central-1.console.aws.amazon.com/ses/home?region=ca-central-1#/account). This can be raised on request. 

### SMS

Currently we are using [long codes in PinPoint](https://ca-central-1.console.aws.amazon.com/pinpoint/home?region=ca-central-1#/sms-account-settings/phoneNumbers) to send SMS. Each long code can send one SMS fragment / second. On staging we have one long code and on production we have 20. So our AWS limits are 1 fragment / second on staging and 20 fragments / second on production. We can request more long codes, though there is a limit (TODO: what is the limit?). Note that the limit for each short code is 100 fragments / second, so switching to short codes would substantially increase our AWS SMS send limit.

## What happens when we send a lot of emails?

Emails are batch saved into the database. This does not appear to be a bottleneck. Each email is send by its own `deliver_email` task.

[`deliver_email()`](https://github.com/cds-snc/notification-api/blob/main/app/celery/provider_tasks.py#L63)
- Fetches the notification using the id
- Calls `send_email_to_provider()`
- So basically a wrapper for send_email_to_provider()

[`send_email_to_provider()`](https://github.com/cds-snc/notification-api/blob/main/app/delivery/send_to_providers.py#L191)
- Prepares the email
- Get the template
- Fill it out
- Get any files if theyâ€™re attached
- Calls `send_email()` with the html and any attachments

[`send_email()`](https://github.com/cds-snc/notification-api/blob/main/app/clients/email/aws_ses.py#L33)
- Creates a MIME email with the html and attachments
- Calls boto3 client function `send_raw_email()` with the MIME email

So there are basically 3 areas that can take time
- `send_email_to_provider()` code before the `send_email()` call
- `send_email()` code before the `send_raw_email()` call
- the `send_raw_email()` call

We have timing metrics for:
- `deliver_email()` (which should be the same as `send_email_to_provider()`): celery_tasks_deliver_email
- `send_email()`: celery_clients_ses_send_email
- `send_raw_email()`:  celery_clients_ses_request-time


We uploaded a csv of 50K emails (with one variable and no file attachments) to staging (send to `success@simulator.amazonses.com`) on July 12, 2:15 pm EST and monitored the [scaling dashboard](https://ca-central-1.console.aws.amazon.com/cloudwatch/home?region=ca-central-1#dashboards/dashboard/ScalingTemp?start=2023-07-12T18%3A10%3A00Z&end=2023-07-12T19%3A30%3A00Z&autoRefresh=false).


![bulk-tasks activity](./diagrams/2023-06-27.scalability.increasing.send.rates/bulk_tasks-queue.png "bulk-task queue")

This graph shows the deliver_email tasks are added to the bulk-tasks queue at a rate of about 7500 / minute. They are being processed at a rate of about 750 / minute.


![deliver_email time](./diagrams/2023-06-27.scalability.increasing.send.rates/deliver_email-average-time.png "deliver_email average time")

This graph shows that each deliver_email task took approximately 0.3 seconds during the load test.


![deliver_email time breakdown](./diagrams/2023-06-27.scalability.increasing.send.rates/deliver_email-breakdown.png "deliver_email breakdown")

From this graph we see that during the deliver_email task:
- 65% of the time is in `deliver_email()` code before calling `send_email()`
- 2% of the time is spent in `send_email()` code before calling `send_raw_email()`
- 33% of the time is spent in the `send_raw_email()` call


## Options

There are two basic areas that can be changed to increase our send rates:
- Notify code
- Notify infrastructure

### Notify code

We can try to speed up:
- the `deliver_email` code before the `send_email` call
- the `send_raw_email()` call

Note that without speeding up the `send_raw_email()` call our improvements will be limited.

#### `deliver_email()`

GDS made a few optimizations around database usage (after we forked the code) that would likely be useful:
- [Improve sender task](https://github.com/alphagov/notifications-api/pull/3134)
- [Add caching and remove extra call to database](https://github.com/alphagov/notifications-api/pull/3145)

#### `send_raw_email()`

AWS supports [sending emails in bulk(https://docs.aws.amazon.com/ses/latest/APIReference-V2/API_SendBulkEmail.html) using a template-based approach similar to how Notify operates. There are limitations (for example, the variables have to be ascii, not unicode) but it might be a significant speedup to bulk sends with no unicode variables (including the case of bulk sends where there are no variables)

### Notify infrastructure

Our approach is already parallelized (an asyncronous task is created for each notification to be delivered). Simply running more tasks at once (ie more workers) would speed things up. This could of course create another bottleneck (we've had issues with the database in the past, for example)

One approach we might want to investigate is creating more celery workers and dedicating them to `deliver_email` and / or `deliver_sms`.

### SMS

Likely much of the work increasing our email send rate will also apply to the sms send rate. In particular reducing database calls and increasing celery workers.

### Production

On 2023-07-20 from 09:30 - 11:00 EDT Notify's email pipeline was full, and the graphs look similar to those of the staging test discussed above.

![prod deliver_email time](./diagrams/2023-06-27.scalability.increasing.send.rates/prod-deliver_email-average-time.png "deliver_email average time")

![prod deliver_email time breakdown](./diagrams/2023-06-27.scalability.increasing.send.rates/prod-deliver_email-breakdown.png "deliver_email breakdown")

## Additional considerations

We should carefully measure the impact of our changes by running a test similar to the above before and after we merge.

## Decision

_TODO: Describe the way forward._

## Consequences

_TODO: Describe foreseen and felt consequences of the decision (possible after 1-3 months)._
