# Fixing scheduling

Date: 2022-10-19

## Status

**DRAFT**

## Context

Scheduled sends can go over the daily limits. For example (all csvs are 4 emails)
- set your daily limit to 5
- Upload a csv and send it immediately. No problem.
- Upload a csv again. You get the daily limit warning and you cannot send nor schedule.
- Increase your limit to 9.
- Upload 4 csvs and schedule them to send on the next hour.
- In a test, 2 of the jobs were send and delivered (so 12 emails delivered in total), the other two became stuck with status "sending". In this case, the notifications had been created but not sent to AWS.
- Approximately 4.25 hours later, the [replay_created_notifications](https://github.com/cds-snc/notification-api/blob/main/app/celery/scheduled_tasks.py#L173) task will see these created notifications and immediately resend them. (now 20 emails delivered in total)


## Bugs

- If you're already over the limit, in an ideal world you would still be able to schedule a send for the next day.
- There is probably a race condition where if jobs are scheduled to send at the same time then they both check and see that there is space remaining for each of them (individually) to send, so they both send.
- Having jobs stuck in a "sending" state will just lead to confusion and support tickets.
- If you're already over the limit, the "created" notifications should not be picked up and sent.

## Possibly Solutions

_TODO: Outline alternatives_

## Additional considerations

_TODO: Anything else we should consider?_

## Decision

_TODO: Describe the way forward._

## Consequences

_TODO: Describe foreseen and felt consequences of the decision (possible after 1-3 months)._
