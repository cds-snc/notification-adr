# Secret Management Options Analysis

Date: 2023-03-28

## Status

**DRAFT**.

## Context

Currently, secret management is done in several different places depending on the part of the solution. This includes encrypted zip files stored along with the code in GitHub. This is not best practice, and has caused issues with secret rollovers. We are investigating alternative methods to manage secrets that put all secrets in one centrally managed location. 

## Options

### HashiCorp Vault SaaS
[HashiCorp Vault](https://www.hashicorp.com/products/vault) is an industry standard, cloud agnostic secret management tool. It has integrations with all major cloud providers, platform offerings (Kubernetes/OpenShift), as well as a generic API. There is a SaaS version that has the infrastructure and application patching managed by HashiCorp.

### HashiCorp Vault Self Hosted
[HashiCorp Vault](https://www.hashicorp.com/products/vault) is an industry standard, cloud agnostic secret management tool. It has integrations with all major cloud providers, platform offerings (Kubernetes/OpenShift), as well as a generic API. There is an open source version that can be self hosted within a Kubernetes Cluster. 

### AWS Secrets Manager
[AWS Secrets Manager](https://aws.amazon.com/secrets-manager) is a first-party AWS offering that integrates natively with AWS resources, and can be implemented within Kubernetes using a CSI Driver. It is built specifically to manage secrets within AWS.

### AWS Parameter Store
[AWS Parameter STore](https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html) is a first-party AWS offering that integrates natively with AWS resources, and can be implemented within Kubernetes using a CSI Driver. It is built to manage parameters within AWS but is encrypted and could theoretically be used to manage secrets as well.


## Additional considerations

### Vault - Common

#### Kubernetes Integration

[Kubernetes Integration is done via the vault secret injector combined with the vault sidecar.](https://developer.hashicorp.com/vault/tutorials/kubernetes/kubernetes-external-vault)

The secret injector is scoped to a service account within kubernetes, and creates a JWT token that is used to authenticate with Vault. The sidecar is a container that runs in parallel with the target pod (e.g. admin or api). The sidecar periodically checks Vault for updates to the secrets and automatically injects the secrets into the target pod. When the secret is updated, the pod does not need to be refreshed, however the code must be written in such a way that it will automatically check for new values for this to be effective. The integration will require modifications to the Kustomize (or Helm) deployment for each application that needs to use it. These modifications are referenced just once. 


#### AWS First Party Services Integration

[AWS Lamba Integration is done via the Vault Lambda extension.](https://developer.hashicorp.com/vault/tutorials/app-integration/aws-lambda#vault_auth_role)

The vault lambda extension must be added to the target code application and deployed within the docker image. Additional logic must be added to the container to actually call vault and leverage the secrets. The extension works by assuming a specific AWS IAM role, and using that to authenticate against Vault. The set up for this is rather complex and convoluted as it requires Vault to also use aws as an authentication back end (So vault authenticates against aws, and aws authenticates against vault). This can (and should) be configured through terraform, and thus once it is done, it will be easy to make changes and run against new environmments. As with Kubernetes, the secret can be updated in vault and it will automatically propagate to the function. **To be confirmed**

#### General Secret Management

Once vault is configured, secret management is very flexible and straight forward. Vault uses the concept of "Secret Engines" to organize secrets. A Secret Engine can be thought of as the "root" organizational structure for a specific application. For example, the Secret Engine could be named "Notification-Production". Within this secrets engine, many "Secrets" can be created. It should be noted that in Vault, the term secret does not refer to a single key/value pair, but a collection of key value pairs. As an example, within the Notification-Production Secret Engine, a Secret could be named "API". This "API" secret would contain **all** key value pairs for the API. 

There are multiple types of Secret Engines. These types typically dictate where the secrets are stored. The default secret engine is a V2 KeyVault which hosts the data within the Vault instance. This is usually sufficient, however it is possible to leverage other Secret Engines, and Vault has Secret Engines that leverage AWS Secrets Manager, and Azure Key Vault as the back end storage repositoroes. Further investigation could be done to see if integrating Vault with AWS Secrets Manager provides the best of both worlds for Notify. 

Secrets and secret key value pairs can also be configured to perform Just In Time (JIT) authentication. In this scenario, when an application needs access to a specific resource, it will make a call to vault and request a JIT token which will have a very short TTL, creating what is essentially a one time use key. This is highly beneficial for security but requires considerable set up, and may have performance impacts. That being said, it is something worth investigating in the future. 

#### IAM 

Vault IAM is similar to AWS IAM, which is to say (unfortunately) that it can be rather complex. Vault identifies user and system accounts as "Entities". These entities are identified as a GUID, making it difficult at a glance to see exactly what an entity is. For this reason, Vault ties a secondary identification method to these entities called "Aliases". Typically the alias of an entity is the display name of a user or system account. Unfortunately, in most IAM scenarios it is not possible to administer an entity based on its alias. Instead once the entity is found by the alias, it is required to make note of the entity guid to manage it.

A positive of vault is that it is very flexible in the authentication methods that can be used. The default vault root administrator will use temporary token authentication, but this is not the recommended approach for day to day use. Instead, authentication can be done via standard username/password, OIDC login to an external IDP (GitHub etc), AWS account delegation, Kubernetes, and more. This makes it very easy to integrate virtually any system within vault. Vault uses the concept of roles that are assigned to an authentication method. The role is a group of policies and permissions that can be assigned to a user who authenticates with this auth method. There will be a default role that will be assigned to the auth method, but additional roles can be specified and requested during login.

Vault uses policies for permission management. A policy is a JSON structured document that defines the permissions to the individual secret engines. Policies use keywords such as "Read","Write" and "List" to define how an entity is permitted to interact with a specific secret engine. These policies can be signed directly to an entity, or assigned to a group (which is a group of entities), or assigned to a role (which is a collection of policies and groups). 

### Vault - Self Hosted (Kubernetes)

#### Cost

Self hosting vault is free from a licensing perspective. There will be a minor additional cost on compute resources within the Kubernetes cluster, however Vault is not typically resource intensive from a compute perspective.

#### Administration Overhead

Vault can be installed in Kubernetes using the Vault Helm chart. This very quickly and easily sets up and configures vault within the Kubernetes cluster. The issue with self-hosted vault is always with Day 2 operations. As a best practice, in a production environment, Vault should be configured in High Availability mode which requires additional configuration. Since the secret engine data resides within the Kubernetes cluster, an automated backup tool such as Velero will be required to ensure that data is protected. If a vault pod is moved from one K8s node to another, the vault will automatically seal itself requiring either manual intervention to unseal, or the implementation of the vault auto-unseal operator. All of this is on top of the day to day IAM administration. Because of this, self hosted vault should only be considered if there are requirements that can not be met via HCP Vault (data residency, private links, cost etc).

### Vault - HCP SaaS

#### Caveats

HCP Vault provides managed offerings but even the highest tier of managed offerings does not provide all features and functionality of self hosted. The following are not available in managed offerings:

Policy:
- GCP Cloud KMS auto-unseal
- Format preserving encryption
- KMIP
- Data masking
- Key management secret engine
- Tokenization

Reliability:
- Disaster recovery replication
- Lease count quotas

Governance:
- FIPS-140-2 & seal wrap
- Entropy augmentation
- Control groups
- HSM auto-unseal

#### Cost

[There are different pricing tiers for HCP Vault based on operational requiremments.](https://www.hashicorp.com/products/vault/pricing) The highest tier of HCP Vault would cost approximately $22k CAD per year. This cost could be split across the entirety of CDS and create a unified secret managemment platform. 

#### Administration Overhead

The administration overhead of HCP vault is less than that of self hosted vault. Only day to day IAM administration is required.

### AWS Secrets Manager

#### Kubernetes Integration

#### AWS First Party Services Integration

#### General Secret Management

#### Cost

#### Administration Overhead

#### IAM 

### AWS Parameter Store

#### Kubernetes Integration

#### AWS First Party Services Integration

#### General Secret Management

#### IAM 

#### Cost

#### Administration Overhead

## Decision

_TODO: Describe the way forward._

## Consequences

_TODO: Describe foreseen and felt consequences of the decision (possible after 1-3 months)._
