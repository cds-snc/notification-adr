# Secrets in Notify

Date: 2022-04-14

## Status

**DRAFT**.

## Context

With recent secrets leaked to the public, we have to familiarize ourselves with how the secrets
we have defined within Notify are used. This document aims to explain exactly how these interact
with different components of our application.

## Methods and libraries

This section enumerates a few methods and libraries to help understand the rest of
the document to casual readers.

### itsdangerous

This is a library that specializes on signing content in a cryptographic manner.
A piece of content that is signed with a [HMAC-SHA1 algorithm](https://en.wikipedia.org/wiki/HMAC)
algorithm. This will not encrypt a message in a one-way manner; we can reverse
the operation if we have the secret and salt used throughout the signing process.
Rather, the goal is to guarantee authenticity and integrity of a message.

> In cryptography, an HMAC (sometimes expanded as either keyed-hash message authentication code or hash-based message authentication code) is a specific type of message authentication code (MAC) involving a cryptographic hash function and a secret cryptographic key. As with any MAC, it may be used to simultaneously verify both the data integrity and authenticity of a message.

> HMAC can provide authentication using a shared secret instead of using digital signatures with asymmetric cryptography. It trades off the need for a complex public key infrastructure by delegating the key exchange to the communicating parties, who are responsible for establishing and using a trusted channel to agree on the key prior to communication.

> [Wikipedia](https://en.wikipedia.org/wiki/HMAC)

### JWT

Notify supports JWT authentication for two scenarios: for authenticating the admin
as a client of the API and for systems that integrate with Notify in a programmatic
manner via the API.

The JWT authentication is the one implemented for [Notify client libraries](https://documentation.notification.canada.ca/en/clients.html).
While JWT can also be implemented by users hitting the API, they generally favor
the easier authentication mechanism of `api_key_v1`.

### Authorization header with api_key_v1

Notify supports authentication via the authorization header when using its API. This
is by far the easiest way to authenticate. A universal unique identifier (version 4)
will get [created for each API key](https://github.com/cds-snc/notification-api/blob/9461b26f9582bdea6fe7c68b3d360597e5eab9ba/app/dao/api_key_dao.py#L17).
This UUID will get signed upon saving into the database.

## Core secrets

This section will review key secrets that Notify has. These are defined as
environment variables that are stored in a cryptographic manner and safely
sourced into the environment during the instantiation of the components that
require these.

### SECRET_KEY

This key is fed to a HMAC-SHA1 algorithm that will sign content and guarantee their
authenticity and integrity. Knowing the key allows for reversal of the signed content
if revealed. Hence it's important to keep it secret.

Leaking this key to the public, although inadvisable, should not lead to revelation
of the public secret, considering all different security layers that Notify has. For
this to be a danger, one would need Notify's raw data in the database located in AWS
network. Hence, many access is required.

If this is leaked, this is strongly advised to rotate. A frequent rotation could
be considered in Notify using the `itsdangerous` library
[capability to do so](https://itsdangerous.palletsprojects.com/en/2.1.x/concepts/#key-rotation).

### DANGEROUS_SALT

> In cryptography, a [salt](https://en.wikipedia.org/wiki/Salt_(cryptography)) is random data that is used as an additional input to a one-way function that hashes data, a password or passphrase. Salts are used to safeguard passwords in storage. Historically, only a cryptographic hash function of the password was stored on a system, but over time, additional safeguards were developed to protect against duplicate or common passwords being identifiable (as their hashes are identical). Salting is one such protection.
> [Wikipedia](https://en.wikipedia.org/wiki/Salt_(cryptography))

Salt used throughout numerous crypto-signing operations. Most likely named
dangerous as it's used with the [itsdangerous](https://itsdangerous.palletsprojects.com/en/2.1.x/)
Python library.

A salt per context could be used in order to increase security, as recommended by
[the itsdangerous library guideline](https://itsdangerous.palletsprojects.com/en/2.1.x/concepts/#the-salt).
Notify only uses one salt though for all context.

## Usages

|                     | SECRET_KEY | DANGEROUS_SALT | Notes                                                                                                                       | Links                                                                                                                                                                                                    |
|---------------------|------------|----------------|-----------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| JWT Authentication  |            |                |                                                                                                                             |                                                                                                                                                                                                          |
| api_key_v1          | Yes        | Yes            |                                                                                                                             |                                                                                                                                                                                                          |
| User password       |            | Yes            | 1. Salt appended to password<br /> 2. UTF encoded<br /> 3. hashlib.hexdigest<br /> 4. Checked against PwnedPasswords API V2 | https://github.com/cds-snc/notification-admin/blob/9e2a1effa7730ed8d54c3c723540856b50fe3f14/app/notify_client/user_api_client.py#L264 https://docs.python.org/3/library/hashlib.html#hashlib.hash.digest |
| API Keys            |            |                |                                                                                                                             |                                                                                                                                                                                                          |
| Password reset code | Yes        | Yes            | Expires after 1 hour.                                                                                                       |                                                                                                                                                                                                          |

## Decision

_TODO: Describe the way forward._

## Consequences

_TODO: Describe foreseen and felt consequences of the decision (possible after 1-3 months)._
