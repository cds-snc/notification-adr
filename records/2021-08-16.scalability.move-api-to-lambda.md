# Move the Notify API from Kubernetes to AWS Lambda

Date: 2021-08-16

## Status

**PROPOSED**

## Context

The SRE team is encouraging us to move the Notify API from Kubernetes to AWS Lambda. AWS Lambda functions allow code to be run in a highly scalable way - we can have hundreds of lambda functions running simulateously, and this auto-scales to meet the number of requests being made to the API. The benefits of doing this are thought to be the following:

- less complexity for the Notify team to manage, compared to Kubernetes
- more scalable API
- less costly compared to kubernetes + Amazon EKS

At the time when Notify was being deployed by CDS, AWS Lambda had a smaller maximum size for a lambda function. Notify was over this limit and so @max deployed it a different way.

Since then, AWS has added support for Docker images and increased the size limit for these to 10 GB. This means it is now possible to deploy the Notify API as a Lambda function.

CDS has now used lambda functions to run the covid alert metrics collection and aggregation (https://github.com/cds-snc/covid-alert-metrics-terraform/tree/main/aws). Lamba functions helped that part of the service to scale well.

## Proposed architecture

AWS Lambda + API Gateway

## Additional considerations

AWS Lambda functions exhibit "cold-start" behaviour, where they can take more than 1 second to respond if they [have not been invoked recently](https://aws.amazon.com/blogs/compute/operating-lambda-performance-optimization-part-1/#:~:text=The%20duration%20of%20a%20cold,test%20functions%20than%20production%20workloads). If we do not mitigate this, the admin site will appear unresponsive at times. One possible mitigation would be to ping the api at some frequency - the heartbeat service we already have in Notify could be used for this.

Another consideration will be the effects on other parts of Notify. If the API can scale much better than in the past, will some other parts of the system become overloaded? The may not be an issue because we queue our upcoming jobs with Celery, but we should do significant load testing before running lambda functions in production.

## Load testing results


## Decision

TBD based on load testing results

## Consequences

_To be discussed._
