# SMS Limits

Date: 2022-11-04

## Status

**DRAFT**

## Context

Originally Notify only had a "combined" email and SMS limit. 

These proposed changes were prompted by an incident where we had a very high and unexpected volume of SMS sends.

## Implementation overview

In order to enforce a new SMS-specific limit, we have added checks to the "front door" of the API, where the post requests come in that result in an SMS send:
- for the `/<uuid:service_id>/send-notification` endpoint used by the Admin "send one off" flow: [app/service/send_notification.py](https://github.com/cds-snc/notification-api/blob/d3412ad3697162550d3f5d73958f488a305d3cf7/app/service/send_notification.py#L66)
- for the job creation endpoint used by the Admin CSV send flow: [app/job/rest.py](https://github.com/cds-snc/notification-api/blob/d3412ad3697162550d3f5d73958f488a305d3cf7/app/job/rest.py#L149)
- for the `/bulk` API endpoint defined in [app/v2/notifications/post_notifications.py](https://github.com/cds-snc/notification-api/blob/d3412ad3697162550d3f5d73958f488a305d3cf7/app/v2/notifications/post_notifications.py#L186)
- for the `/sms` API endpoint defined in [app/v2/notifications/post_notifications.py](https://github.com/cds-snc/notification-api/blob/d3412ad3697162550d3f5d73958f488a305d3cf7/app/v2/notifications/post_notifications.py#L228)

Before arriving at this solution, we tried adding checks to other places in the API code (ie celery), including where the notifications are created in the database and where they are sent to SES. These other locations proved prone to errors and difficult to test, which led us to move all related code to the "front door".

(Placeholder for diagram)

## API implementation notes

There are six main back end pieces:
- A column in the Services table indicating the SMS fragment daily limit for that service.
- A counter in redis which tracks how many fragments have been sent that day.
- Code to increment the counter appropriately.
- Code to compare the counter to the service's daily limit.
- New SMS Limits specific emails
- Code to send the emails to the service owners when they reach 80% or 100% of their daily limit.

## Admin implementation notes

For V1 we made the minimal set of changes:
- An error message that is displayed in the CSV send flow.
- An error message that is diplayed in the "one off" and "send to myself" send flows.
- A new entry on the settings page that is visible to users "Daily text fragments limit".
- A corresponding new entry in the platform admin settings to allow this limit to be changed.

## Additional considerations

Phasing of the release of this feature is as follows:
V1: technical implementation, especially on the API side. Minimum viable UI changes.
V2: UI changes to better surface the SMS Limit to users, after usability testing occurs.

## Decision

- We have implemented V1 as described.
- We have yet to refine and implement V2.
## Consequences

- We have better control over the amount of SMS being sent.
- Service owners could be confused over the new restrictions.
