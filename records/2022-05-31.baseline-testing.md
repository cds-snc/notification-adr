# Baseline performance testing

Date: 2022-05-21

## Status

**DRAFT**

## Context

We need to collect performance metrics that are more closely aligned with current and predicted system usage patterns, in order to help tune and scale Notify.
We would also like to have a standard procedure for evaluating the affect of code optimizations on system performance.

## Methods and libraries

This section enumerates a few methods and libraries to help understand the rest of
the document to casual readers.

### [Hasura](https://hasura.io/)

Hasura is a graphQL / postgreSQL engine we have connected to our database that we can use for one-off queries.

### [locust](https://locust.io/)

Locust is a widely-used python-based tool for performance testing.

### Message priorities

Messages can have priority "bulk", "normal", or "priority".

## [Acceptance criteria](https://app.zenhub.com/workspaces/notify-planning-614b3ad91bc2030015ed22f5/issues/cds-snc/notification-planning/351)

* Build awareness among the team and we all know what our current baseline is
* Measure everything in our [SLO](https://docs.google.com/spreadsheets/d/1fU-FJ7THfWEqNhbpQ4r22MQipFwC7SP851ZQnOf68cM)
* Use historic data to baseline what we deliver to clients in production
* Test limits of Notify to know what # of API requests per minute Notify can handle (currently 6,000 emails/minute)
* What's our current sending capacity?
* Know max delays for various kinds of sending (bulk, manual, email, SMS)
* Comparing performance against # of support tickets, # of incidents
* See how much our volume of messages sent has grown
* Develop recommendations for better ways to measure metric (some of our metrics might not be very accurate right now)

## Historical usage

[Some analysis with Python](../python/baseline_stats.ipynb)

### Breakdown

| Month  | Total |
| ------- | ------- |
| 2022-01 |	2300506 |
| 2022-02 |	2410295 |
| 2022-03 |	4011291 |
| 2022-04 |	4930607 |
| 2022-05 |	3165550 |


| month   | type   |   count |   percent |
|:--------|:-------|--------:|----------:|
| 2022-01 | email  | 2234721 |      97.1 % |
|         | sms    |   65783 |       2.9 % |
| 2022-02 | email  | 2337695 |      97.0 % |
|         | sms    |   72594 |       3.0 % |
| 2022-03 | email  | 3905388 |      97.4 % |
|         | sms    |  105894 |       2.6 % |
| 2022-04 | email  | 4807629 |      97.5 % |
|         | sms    |  122943 |       2.5 % |
| 2022-05 | email  | 3071041 |      97.0 % |
|         | sms    |   94466 |       3.0 % |


| month   | priority   |   count |   percent |
|:--------|:-----------|--------:|----------:|
| 2022-01 | bulk       |  424493 |      18.5 % |
|         | normal     | 1859685 |      80.8 % |
|         | priority   |   16326 |       0.7 % |
| 2022-02 | bulk       |  523494 |      21.7 % |
|         | normal     | 1862528 |      77.3 % |
|         | priority   |   24267 |       1.0 % |
| 2022-03 | bulk       | 1695289 |      42.3 % |
|         | normal     | 2269286 |      56.6 % |
|         | priority   |   46707 |       1.2 % |
| 2022-04 | bulk       | 2406941 |      48.8 % |
|         | normal     | 2456123 |      49.8 % |
|         | priority   |   67508 |       1.4 % |
| 2022-05 | bulk       |  480625 |      15.2 % |
|         | normal     | 2302800 |      72.7 % |
|         | priority   |  382082 |      12.1 % |


### Time to send emails (seconds)

| month   | priority   |   processing_50 |   processing_90 |   processing_99 |
|:--------|:-----------|----------------:|----------------:|----------------:|
| 2022-01 | bulk       |              20 |              49 |              68 |
|         | normal     |               7 |              34 |              73 |
|         | priority   |               1 |               1 |               2 |
| 2022-02 | bulk       |              18 |             881 |            2615 |
|         | normal     |               6 |              34 |              71 |
|         | priority   |               1 |               1 |               3 |
| 2022-03 | bulk       |             897 |            2188 |            2935 |
|         | normal     |               4 |             972 |            3180 |
|         | priority   |               1 |             527 |             644 |
| 2022-04 | bulk       |            1238 |            2608 |            3374 |
|         | normal     |               3 |             508 |            1144 |
|         | priority   |               1 |               2 |              11 |
| 2022-05 | bulk       |             350 |            1510 |            2351 |
|         | normal     |              12 |             974 |            1685 |
|         | priority   |               2 |               9 |              20 |

### Time to send texts (seconds)

| month   | priority   |   processing_50 |   processing_90 |   processing_99 |
|:--------|:-----------|----------------:|----------------:|----------------:|
| 2022-01 | normal     |              17 |             118 |             451 |
|         | priority   |               1 |               1 |               5 |
| 2022-02 | normal     |              19 |             212 |             557 |
|         | priority   |               1 |               2 |               5 |
| 2022-03 | normal     |              16 |             345 |            1326 |
|         | priority   |               1 |               1 |               4 |
| 2022-04 | normal     |              23 |             381 |            3271 |
|         | priority   |               1 |               2 |               5 |
| 2022-05 | normal     |               8 |             239 |             575 |
|         | priority   |               1 |               2 |               6 |

### Basic usage types

* Newsletters or other bulk messages: a message sent at the same time to a large number of users. Usually not time sensitive.

* Personal messages: messages sent to one user. For example, confirmation of the user submitting a form. These should be delivered relatively quickly but can likely wait a minute or two.

* Multi-factor authentication (MFA): services sending users a log in code. In this situation the user is waiting for the message to arrive before continuing with their activity, so speed of delivery is critical.


Many of our notifications are sent in large bursts. Occasionally two or more services will simultaneously be doing a large send. At the same time other services are trickling through a small number of messages (including MFA messages).

### Useful Data

* Monthly volumes of sms / email, and priority / normal / bulk and month over month growth.
  * Use these to get rough idea of proportion of different types of data.
* Historical burst sizes and composition.
  * Perhaps the busiest hour long period in each month?
  * Use these to get an idea of how much total traffic to baseline.

Some initial queries at
https://docs.google.com/spreadsheets/d/1G8Eno3FkISdaZf_ySgDHiURnUZyJiz0CqErqC7iRCLk

[Some analysis with Python](../python/baseline_stats.ipynb)

### Data summary

* The largest recent hour burst was in March, with 146253 notifications.
* Priority messages were about 1% of traffic, however in May we started getting much more 2FA notifications, pushing the priority notifactions to 12% of total. It is difficult at this time to determine what the future proportion of priority messages will be.

## Possible tests

* Run an hour long test, with twice the data of the busiest time (or perhaps twice rounded up to the nearest 100K).
* Use the average monthly proportion of different types of data.
* Question: Do we worry about SMS? Can we assume that they'll spend the same amount of time in Notify as emails?


## Other questions

* How are we going to get reports / alerts out?
* How do we incorporate whether any locust POSTs failed and the POSTs' response times?
* There is an inflection point at which if we are sending more per minute we will start falling more and more behind. How do we compute and track this?
* We should occasionally run these tests on prod so that we know how staging predictions compare to what we would see in production. How often / when? Manual or automated?
* Where should the test code live? (api / attic / performance-test-results)

## Recommandations

* Test 200000 over an hour, with 15% priority, 55% normal and 30% bulk.
* Test 400000 over an hour, with 15% priority, 55% normal and 30% bulk.
* Other tests or things we should do?

## Consequences

_TODO: Describe foreseen and felt consequences of the decision (possible after 1-3 months)._
